<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Educativo IA</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Marked (Markdown Parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* Markdown Styles within Chat */
        .prose p {
            margin-bottom: 0.75em;
        }

        .prose p:last-child {
            margin-bottom: 0;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }

        .prose strong {
            font-weight: 700;
            color: inherit;
        }

        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
            font-size: 0.9em;
        }

        .prose th {
            background-color: #f1f5f9;
            text-align: left;
            padding: 8px 12px;
            font-weight: 600;
            border: 1px solid #e2e8f0;
        }

        .prose td {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
        }

        .prose h1,
        .prose h2,
        .prose h3 {
            font-weight: 700;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
    </style>
</head>

<body class="bg-slate-100 h-screen overflow-hidden flex flex-col items-center justify-center">

    <div id="root" class="w-full h-full max-w-6xl mx-auto bg-white shadow-2xl relative flex overflow-hidden"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Constants
        // Constants
        const WEBHOOK_URL = "https://n8n-n8n.ehqtcd.easypanel.host/webhook-test/chat-educativo";
        // TODO: Replace with the actual URL to fetch rubrics (e.g., another n8n webhook or Baserow API)
        const RUBRICS_LIST_URL = "https://n8n-n8n.ehqtcd.easypanel.host/webhook-test/get-rubrics";

        // --- COMPONENTS ---

        // --- COMPONENTS ---

        const LoadingIndicator = () => {
            const messages = [
                "Analizando tu solicitud... üßê",
                "Estamos trabajando, ten paciencia... ‚è≥",
                "¬øSab√≠as que el cerebro humano genera unos 20 vatios de potencia? üß†‚ö°",
                "Curiosidad: Los antiguos romanos usaban orina para blanquear sus dientes. ü¶∑üèõÔ∏è",
                "Preparando la mejor respuesta educativa para ti... üéì",
                "¬øSab√≠as que el primer programador del mundo fue una mujer? Ada Lovelace. üíªüë©‚Äçüíª",
                "Dato curioso: Las abejas pueden reconocer rostros humanos. üêùüë§",
                "Refinando los criterios de evaluaci√≥n... ‚ú®",
                "¬øSab√≠as que Isaac Newton descubri√≥ la gravedad durante una cuarentena? üçéüè†",
                "Cargando conocimiento... üìö",
                "Dato: El Sol es 1.3 millones de veces m√°s grande que la Tierra. ‚òÄÔ∏èüåç"
            ];

            const [index, setIndex] = React.useState(0);

            React.useEffect(() => {
                const interval = setInterval(() => {
                    setIndex(prev => (prev + 1) % messages.length);
                }, 4000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="flex justify-start animate-fade-in mb-6">
                    <div className="px-5 py-4 rounded-2xl bg-white border border-slate-100 shadow-sm rounded-tl-none flex flex-col gap-3 max-w-[80%] md:max-w-[70%]">
                        <div className="flex items-center gap-2">
                            <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                            <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                            <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                        </div>
                        <p className="text-xs text-slate-500 font-medium italic animate-pulse">
                            {messages[index]}
                        </p>
                    </div>
                </div>
            );
        };

        const MessageBubble = ({ message }) => {
            const isUser = message.role === 'user';
            const contentRef = useRef(null);

            const handleDownload = () => {
                const element = contentRef.current;
                const opt = {
                    margin: [10, 10],
                    filename: 'Correccion_IA.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(element).save();
            };

            return (
                <div className={`flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in mb-6`}>
                    <div className={`flex max-w-[85%] md:max-w-[75%] gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>
                        {/* Avatar */}
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-sm ${isUser ? 'bg-indigo-600 text-white' : 'bg-emerald-100 text-emerald-600 border border-emerald-200'}`}>
                            <i className={`fas ${isUser ? 'fa-user' : 'fa-robot'}`}></i>
                        </div>

                        {/* Bubble */}
                        <div className={`flex flex-col ${isUser ? 'items-end' : 'items-start'} w-full`}>
                            <div className={`px-5 py-4 rounded-2xl shadow-sm text-sm leading-relaxed w-full ${isUser
                                ? 'bg-indigo-600 text-white rounded-tr-none'
                                : 'bg-white border border-slate-100 text-slate-700 rounded-tl-none'
                                }`}>
                                {/* Files attached by User */}
                                {message.files && message.files.length > 0 && (
                                    <div className="mb-3 flex flex-wrap gap-2">
                                        {message.files.map((file, idx) => (
                                            <div key={idx} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium ${isUser ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-600'}`}>
                                                <i className="fas fa-file-pdf"></i>
                                                <span className="truncate max-w-[150px]">{file.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* Message Content (Markdown) */}
                                {isUser ? (
                                    <p className="whitespace-pre-wrap">{message.content}</p>
                                ) : (
                                    <div ref={contentRef}>
                                        <div
                                            className="prose prose-slate max-w-none"
                                            dangerouslySetInnerHTML={{ __html: marked.parse(message.content) }}
                                        />
                                    </div>
                                )}
                            </div>

                            {/* Actions / Timestamp */}
                            <div className="flex items-center gap-2 mt-1 px-1">
                                <span className="text-xs text-slate-400">{message.timestamp}</span>
                                {!isUser && (message.content.includes('<table') || message.content.includes('| ---') || /r√∫brica|correcci√≥n|evaluaci√≥n|resultado/i.test(message.content)) && (
                                    <button
                                        onClick={handleDownload}
                                        className="text-xs text-indigo-600 hover:text-indigo-800 font-medium ml-2 flex items-center gap-1 transition-colors"
                                        title="Descargar PDF"
                                    >
                                        <i className="fas fa-file-download"></i> Descargar PDF
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ChatInput = ({ onSend, loading }) => {
            const [text, setText] = useState("");
            const [files, setFiles] = useState([]);
            const fileInputRef = useRef(null);

            const handleSubmit = (e) => {
                e && e.preventDefault();
                // Allow sending if there's text OR files
                if ((!text.trim() && files.length === 0) || loading) return;

                onSend(text, files);
                setText("");
                setFiles([]);
            };

            const handleFileChange = (e) => {
                const selectedFiles = e.target.files;
                if (selectedFiles && selectedFiles.length > 0) {
                    const newFiles = Array.from(selectedFiles);

                    setFiles(prev => {
                        // Prevent duplicates based on name and size
                        const filtered = newFiles.filter(newFile =>
                            !prev.some(existing => existing.name === newFile.name && existing.size === newFile.size)
                        );
                        return [...prev, ...filtered];
                    });
                }

                // Clear the input value to allow re-selecting the same file
                // We do this AFTER capturing the files
                if (fileInputRef.current) {
                    fileInputRef.current.value = "";
                }
            };

            const removeFile = (index) => {
                setFiles(prev => prev.filter((_, i) => i !== index));
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSubmit();
                }
            };

            return (
                <div className="p-4 bg-white border-t border-slate-100">
                    {/* File Previews */}
                    {files.length > 0 && (
                        <div className="flex gap-2 mb-3 overflow-x-auto pb-2 custom-scrollbar">
                            {files.map((file, i) => (
                                <div key={i} className="relative group shrink-0">
                                    <div className="flex items-center gap-2 bg-indigo-50 border border-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-xs font-medium shadow-sm">
                                        <i className="fas fa-file-pdf"></i>
                                        <span className="truncate max-w-[120px]">{file.name}</span>
                                        <button onClick={() => removeFile(i)} className="ml-1 hover:text-red-500 transition-colors">
                                            <i className="fas fa-times-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Input Bar */}
                    <div className="flex items-end gap-3 max-w-4xl mx-auto bg-slate-50 p-2 rounded-xl border border-slate-200 focus-within:border-indigo-400 focus-within:ring-2 focus-within:ring-indigo-100 transition-all shadow-sm">
                        <button
                            onClick={() => fileInputRef.current.click()}
                            className="p-3 text-slate-400 hover:text-indigo-600 transition-colors hover:bg-slate-200 rounded-lg shrink-0"
                            title="Adjuntar archivo"
                        >
                            <i className="fas fa-paperclip text-lg"></i>
                        </button>
                        <input
                            type="file"
                            multiple
                            ref={fileInputRef}
                            className="hidden"
                            onChange={handleFileChange}
                        />

                        <textarea
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                            onKeyDown={handleKeyDown}
                            placeholder="Escribe tu mensaje aqu√≠..."
                            className="w-full bg-transparent border-none focus:ring-0 text-slate-700 text-sm resize-none py-3 max-h-[120px] overflow-y-auto placeholder:text-slate-400"
                            rows="1"
                            style={{ minHeight: '44px' }}
                        ></textarea>

                        <button
                            onClick={handleSubmit}
                            disabled={loading || (!text.trim() && files.length === 0)}
                            className={`p-3 rounded-lg shrink-0 transition-all ${loading || (!text.trim() && files.length === 0)
                                ? 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md transform active:scale-95'
                                }`}
                        >
                            {loading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-paper-plane"></i>}
                        </button>
                    </div>
                    <p className="text-center text-xs text-slate-400 mt-3">
                        Evaluador IA Pro puede cometer errores. Revisa siempre las correcciones.
                    </p>
                </div>
            );
        };

        const ChatApp = () => {
            const [messages, setMessages] = useState([]);
            const [loading, setLoading] = useState(false);
            const [rubricContext, setRubricContext] = useState("");

            // Baserow / Session State
            const [sessionID, setSessionID] = useState("");

            const messagesEndRef = useRef(null);

            // Init Session
            useEffect(() => {
                // 1. Session ID Management
                let storedID = localStorage.getItem("chat_session_id");
                if (!storedID) {
                    storedID = 'prof_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem("chat_session_id", storedID);
                }
                setSessionID(storedID);
                console.log("Session ID:", storedID);

                // 2. Initial Trigger (Greeting from n8n)
                triggerInitSession(storedID);
            }, []);

            const triggerInitSession = async (sid) => {
                setLoading(true);
                const formData = new FormData();
                formData.append('chat_message', 'INIT_SESSION');
                formData.append('alumno_id', sid);
                formData.append('chat_history', JSON.stringify([]));

                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) throw new Error("Error iniciando sesi√≥n con n8n");
                    const data = await response.json();

                    let botReply = data.reply || "¬°Hola! Soy tu Asistente Educativo. ¬øEn qu√© puedo ayudarte hoy?";
                    if (botReply) {
                        botReply = botReply.replace(/^[\s\t]+(<)/gm, '$1');
                    }

                    setMessages([{
                        role: 'assistant',
                        content: botReply,
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    }]);

                    if (data.new_rubric_context) setRubricContext(data.new_rubric_context);

                } catch (err) {
                    console.error("Init Session Error:", err);
                    setMessages([{
                        role: 'assistant',
                        content: "‚ö†Ô∏è No se pudo obtener el saludo inicial, pero puedes empezar a escribir.",
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    }]);
                } finally {
                    setLoading(false);
                }
            };

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleSend = async (text, files) => {
                const newMessage = {
                    role: 'user',
                    content: text,
                    files: files,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };

                setMessages(prev => [...prev, newMessage]);
                setLoading(true);

                const formData = new FormData();
                formData.append('chat_message', text);

                // identity
                formData.append('alumno_id', sessionID);

                const historyPayload = messages.map(m => ({
                    role: m.role,
                    content: m.content
                }));
                formData.append('chat_history', JSON.stringify(historyPayload));

                if (rubricContext) {
                    formData.append('rubric_context', rubricContext);
                }

                if (files && files.length > 0) {
                    console.log(`Adjuntando ${files.length} archivos al FormData.`);
                    files.forEach(file => {
                        formData.append('file', file, file.name);
                    });
                }

                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error("Error con n8n");

                    const data = await response.json();

                    let botReply = data.reply || "‚ö†Ô∏è Respuesta vac√≠a del servidor.";

                    if (botReply) {
                        botReply = botReply.replace(/^[\s\t]+(<)/gm, '$1');
                    }

                    const newContext = data.new_rubric_context;
                    if (newContext) {
                        console.log("Updating Rubric Context...", newContext.substring(0, 50) + "...");
                        setRubricContext(newContext);
                    }

                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: botReply,
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    }]);

                } catch (err) {
                    console.error(err);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: "‚ùå **Error:** " + err.message + "\n\n(Revisa la consola)",
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    }]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col w-full h-full bg-white">
                    {/* Header */}
                    <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-10">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md">
                                <i className="fas fa-brain"></i>
                            </div>
                            <h1 className="font-bold text-slate-800 text-lg tracking-tight">Asistente Educativo <span className="text-indigo-600">AI</span></h1>
                        </div>
                        <div className="flex gap-2">
                            <button className="p-2 text-slate-400 hover:bg-slate-50 rounded-full transition-colors" title="Limpiar Chat" onClick={() => { setMessages([]); setRubricContext(""); }}>
                                <i className="fas fa-trash-alt"></i>
                            </button>
                            <button className="p-2 text-slate-400 hover:bg-slate-50 rounded-full transition-colors">
                                <i className="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50/50">
                        <div className="max-w-4xl mx-auto py-4">
                            {messages.map((msg, index) => (
                                <MessageBubble key={index} message={msg} />
                            ))}
                            {loading && <LoadingIndicator />}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    {/* Input Area */}
                    <ChatInput onSend={handleSend} loading={loading} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatApp />);
    </script>
</body>

</html>