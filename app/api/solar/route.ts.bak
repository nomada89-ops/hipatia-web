import { NextRequest, NextResponse } from 'next/server';
import Database from 'better-sqlite3';
import path from 'path';

export async function GET(request: NextRequest) {
    const searchParams = request.nextUrl.searchParams;
    const type = searchParams.get('type'); // 'live' or 'history'

    // Initialize DB connection
    // In dev, Next.js might re-compile, so we need to be careful with connections.
    // Ideally, this should be a singleton, but for this scale, opening/closing is okay or relying on better-sqlite3's handling.
    try {
        const dbPath = path.join(process.cwd(), 'solar.db');
        const db = new Database(dbPath, { readonly: true });

        if (type === 'history') {
            const stmt = db.prepare('SELECT * FROM daily_stats ORDER BY date DESC LIMIT 30');
            const data = stmt.all();
            db.close();
            return NextResponse.json(data);
        }

        if (type === 'live') {
            // Get the last 24 hours of readings
            // 24 hours * 12 points/hour = 288 points
            const stmt = db.prepare(`
        SELECT * FROM readings 
        WHERE timestamp >= datetime('now', '-24 hours') 
        ORDER BY id ASC
      `);
            const data = stmt.all();

            // Get latest reading for current status
            const latestStmt = db.prepare('SELECT * FROM readings ORDER BY id DESC LIMIT 1');
            const latest = latestStmt.get();

            db.close();
            return NextResponse.json({
                chartData: data,
                current: latest || {}
            });
        }

        db.close();
        return NextResponse.json({ error: 'Invalid type parameter. Use ?type=live or ?type=history' }, { status: 400 });

    } catch (error) {
        console.error('Database Error:', error);
        return NextResponse.json({ error: 'Failed to fetch data' }, { status: 500 });
    }
}
